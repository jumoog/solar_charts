<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="js/jquery.min.js"></script>
  <script src="js/knockout-min.js"></script>
  <script src="js/Chart.bundle.js"></script>
  <script src="js/chartjs-plugin-annotation.js"></script>
  <title>ðŸŒžSolar ChartðŸ“ˆ</title>
</head>

<body>
  <form>
    <div id="chartContainer">
      <label for="bday">Start:</label>
      <input type="date" id="start" name="start">
      <label for="bday">End:</label>
      <input type="date" id="end" name="end">
      <input type="submit">
    </div>
  </form>
  <div>
    <canvas id="canvas"></canvas>
  </div>

  <script>
    window.chartColors = {
      mpp_1: 'rgb(0, 204, 255)',
      mpp_2: 'rgb(0, 230, 0)',
      acc: 'rgb(255, 0, 255)',
      gpp: 'rgb(0, 0, 255)',
      red: 'rgb(255, 0, 0)',
      orange: 'rgb(255, 159, 64)',
      yellow: 'rgb(255, 205, 86)',
      green: 'rgb(75, 192, 192)',
      blue: 'rgb(54, 162, 235)',
      purple: 'rgb(153, 102, 255)',
      grey: 'rgb(201, 203, 207)'
    };
    var url_string = window.location.href; //window.location.href
    var url = new URL(url_string);
    var start = url.searchParams.get("start");
    var end = url.searchParams.get("end");
    if (end === null) {
      end = "2018-06-09";
      start = "2018-05-26";
    }
    var date_input = document.getElementById('start');
    date_input.valueAsDate = new Date(start);
    var date_input2 = document.getElementById('end');
    date_input2.valueAsDate = new Date(end);
    date_input.onchange = function () {
      date_input2.valueAsDate = new Date(this.value);
    }
    $.getJSON("data", {
      start: start,
      end: end
    }, function (result) {
      var labels = [],
        MPPT1 = [];
      MPPT2 = [];
      MPPT = [];
      EP = [];
      for (var i = 0; i < result.length; i++) {
        labels.push(result[i].Date + " - " + result[i].Time);
        MPPT1.push(((result[i]["Udc MPPT1[V]"] * result[i]["Idc MPPT1[A]"]) / 1000).toFixed(2));
        MPPT2.push(((result[i]["Udc MPPT2[V]"] * result[i]["Idc MPPT2[A]"]) / 1000).toFixed(2));
        MPPT.push((((result[i]["Udc MPPT2[V]"] * result[i]["Idc MPPT2[A]"]) + (result[i]["Udc MPPT1[V]"] * result[i]
          ["Idc MPPT1[A]"])) / 1000).toFixed(2));
        EP.push(((result[i]["Energy positiv [Ws]"] / result[i]["Periode [s]"]) / 1000).toFixed(2));

      }
      var config = {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
              label: "Leistung MPP1 [kW]",
              backgroundColor: window.chartColors.mpp_1,
              borderColor: window.chartColors.mpp_1,
              borderWidth: 2,
              fill: false,
              data: MPPT1
            },
            {
              label: "Leistung MPP2 [kW]",
              backgroundColor: window.chartColors.mpp_2,
              borderColor: window.chartColors.mpp_2,
              borderWidth: 2,
              fill: false,
              data: MPPT2
            },
            {
              label: "Leistung MPP Gesamt [kW]",
              backgroundColor: window.chartColors.gpp,
              borderColor: window.chartColors.gpp,
              borderWidth: 2,
              fill: false,
              data: MPPT
            },
            {
              label: "AC Leistung [kW]",
              backgroundColor: window.chartColors.acc,
              borderColor: window.chartColors.acc,
              borderWidth: 2,
              fill: false,
              data: EP
            },
          ]
        },
        options: {
          responsive: true,
          title: {
            display: true,
            text: 'Solar Chart'
          },
          elements: {
            point: {
              radius: 0
            }
          },
          tooltips: {
            mode: 'index',
            intersect: false,
          },
          hover: {
            mode: 'nearest',
            intersect: false,
          },
          annotation: {
            annotations: [{
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y-axis-0',
                value: 8.2,
                borderColor: window.chartColors.red,
                borderWidth: 2,
                label: {
                  enabled: true,
                  content: 'Engpass Leistung (8,2 kW)'
                }
              },
              {
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y-axis-0',
                value: 6.93,
                borderColor: window.chartColors.red,
                borderWidth: 2,
                label: {
                  enabled: true,
                  content: '70% Abregelung (6,93 kW)'
                }
              }
            ]
          },
          scales: {
            xAxes: [{
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Zeit'
              }
            }],
            yAxes: [{
              display: true,
              scaleLabel: {
                display: true,
                labelString: 'Leistung [kW]'
              }
            }]
          }
        }
      };

      var ctx = document.getElementById("canvas").getContext("2d");
      window.myLine = new Chart(ctx, config);
      var colorNames = Object.keys(window.chartColors);
    });
  </script>
</body>

</html>